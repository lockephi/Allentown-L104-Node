version: '3.8'

services:
  l104-node:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
      - "8080:8080"
      - "4160:4160"
      - "4161:4161"
      - "2404:2404"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GEMINI_API_BASE=${GEMINI_API_BASE:-https://generativelanguage.googleapis.com/v1beta}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-3-flash-preview}
      - GEMINI_ENDPOINT=${GEMINI_ENDPOINT:-:streamGenerateContent}
      - ENABLE_FAKE_GEMINI=${ENABLE_FAKE_GEMINI:-0}
      - MEMORY_DB_PATH=/data/memory.db
      - RAMNODE_DB_PATH=/data/ramnode.db
      - SELF_BASE_URL=${SELF_BASE_URL:-http://localhost:8081}
      - DISABLE_RATE_LIMIT=${DISABLE_RATE_LIMIT:-FALSE}
      - RESONANCE=${RESONANCE:-527.5184818492537}
    volumes:
      - l104-data:/app/data
    restart: always
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; r=httpx.get('http://localhost:8081/health'); exit(0 if r.status_code==200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

volumes:
  l104-data:
    driver: local
