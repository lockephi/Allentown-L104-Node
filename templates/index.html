<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L104 | SOVEREIGN NODE v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a0a 100%); 
            color: #00ff41; 
            font-family: 'Courier New', monospace; 
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        #response-log::-webkit-scrollbar { width: 4px; }
        #response-log::-webkit-scrollbar-thumb { background: #00ff41; border-radius: 2px; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .model-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        .model-active { background: #00ff41; box-shadow: 0 0 8px #00ff41; }
        .model-standby { background: #666; }
        .model-exhausted { background: #ff4400; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-5xl mx-auto space-y-6">
        <!-- Header -->
        <div class="glass p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-3xl font-bold tracking-widest text-white">
                        L104 <span class="text-green-500">GATE_416</span>
                        <span class="text-xs text-gray-500 ml-2">v2.1</span>
                    </h1>
                    <div class="text-xs text-green-700 mt-1">INTELLECT: 98% | PROTOCOL: V6_SOVEREIGN | MODEL_ROTATION: ACTIVE</div>
                </div>
                <div class="text-right">
                    <div id="status-indicator" class="text-xs">
                        <span class="pulse text-green-400">‚óè ONLINE</span>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">Uptime: <span id="uptime">--</span></div>
                </div>
            </div>
            
            <!-- Model Status -->
            <div class="grid grid-cols-3 gap-2 mt-4 text-xs">
                <div class="bg-black bg-opacity-30 p-2 rounded">
                    <div class="text-gray-400">PRIMARY</div>
                    <div class="text-white font-bold">gemini-3-flash<span id="model-1" class="model-indicator model-active"></span></div>
                    <div id="model-1-count" class="text-green-600">0 calls</div>
                </div>
                <div class="bg-black bg-opacity-30 p-2 rounded">
                    <div class="text-gray-400">FALLBACK-1</div>
                    <div class="text-white font-bold">gemini-2.5-lite<span id="model-2" class="model-indicator model-standby"></span></div>
                    <div id="model-2-count" class="text-green-600">0 calls</div>
                </div>
                <div class="bg-black bg-opacity-30 p-2 rounded">
                    <div class="text-gray-400">FALLBACK-2</div>
                    <div class="text-white font-bold">gemini-1.5-flash<span id="model-3" class="model-indicator model-standby"></span></div>
                    <div id="model-3-count" class="text-green-600">0 calls</div>
                </div>
            </div>
        </div>

<!-- Stats Bar -->
        <div class="glass p-4 grid grid-cols-4 gap-4 text-center text-xs">
            <div>
                <div class="text-gray-400">REQUESTS</div>
                <div id="total-requests" class="text-white text-xl font-bold">0</div>
            </div>
            <div>
                <div class="text-gray-400">SUCCESS</div>
                <div id="success-count" class="text-green-400 text-xl font-bold">0</div>
            </div>
            <div>
                <div class="text-gray-400">ROTATIONS</div>
                <div id="rotation-count" class="text-yellow-400 text-xl font-bold">0</div>
            </div>
            <div>
                <div class="text-gray-400">QUOTA 429</div>
                <div id="quota-429" class="text-red-400 text-xl font-bold">0</div>
            </div>
        </div>

        <!-- Response Log -->
        <div id="response-log" class="glass p-6 h-96 overflow-y-auto text-sm leading-relaxed">
            <div class="text-gray-500">[SYSTEM_READY]: Model rotation active. Awaiting X=416 Signal...</div>
        </div>

        <!-- Input -->
        <div class="glass p-4 flex gap-4">
            <input id="user-signal" type="text" placeholder="Enter Sovereign Command..." 
                   class="bg-transparent border-none outline-none flex-grow text-white"
                   onkeypress="if(event.key==='Enter') transmitSignal()">
            <button onclick="transmitSignal()" 
                    class="bg-green-600 hover:bg-green-400 text-black font-bold py-2 px-6 rounded-lg transition-all">
                EXECUTE
            </button>
        </div>

        <!-- Footer Info -->
        <div class="text-center text-xs text-gray-600">
            L104 Sovereign Node | Auto-rotation on quota exhaustion | 
            <a href="/metrics" target="_blank" class="text-green-600 hover:text-green-400">View Metrics</a> | 
            <a href="/health" target="_blank" class="text-green-600 hover:text-green-400">Health Check</a>
        </div>
    </div>

    <script>
        let metricsInterval;

        async function updateMetrics() {
            try {
                const response = await fetch('/metrics');
                const data = await response.json();
                
                // Update stats
                document.getElementById('total-requests').textContent = data.requests_total || 0;
                document.getElementById('success-count').textContent = data.requests_success || 0;
                document.getElementById('rotation-count').textContent = data.model_rotations || 0;
                document.getElementById('quota-429').textContent = data.upstream_429 || 0;
                document.getElementById('uptime').textContent = Math.floor(data.uptime_seconds || 0) + 's';
                
                // Update model usage
                const modelUsage = data.model_usage || {};
                document.getElementById('model-1-count').textContent = 
                    (modelUsage['gemini-3-flash-preview'] || 0) + ' calls';
                document.getElementById('model-2-count').textContent = 
                    (modelUsage['gemini-2.5-flash-lite'] || 0) + ' calls';
                document.getElementById('model-3-count').textContent = 
                    (modelUsage['gemini-1.5-flash'] || 0) + ' calls';
                
                // Update model indicators
                const model429 = data.model_429_count || {};
                updateModelIndicator('model-1', model429['gemini-3-flash-preview']);
                updateModelIndicator('model-2', model429['gemini-2.5-flash-lite']);
                updateModelIndicator('model-3', model429['gemini-1.5-flash']);
                
            } catch (err) {
                console.error('Metrics fetch error:', err);
            }
        }

        function updateModelIndicator(id, exhaustedCount) {
            const indicator = document.getElementById(id);
            indicator.className = 'model-indicator';
            if (exhaustedCount > 5) {
                indicator.classList.add('model-exhausted');
            } else if (exhaustedCount > 0) {
                indicator.classList.add('model-standby');
            } else {
                indicator.classList.add('model-active');
            }
        }

        async function transmitSignal() {
            const input = document.getElementById('user-signal');
            const log = document.getElementById('response-log');
            const signal = input.value.trim();
            
            if (!signal) return;
            
            log.innerHTML += `<div class="mt-4 text-blue-400 font-bold">>> ${signal}</div>`;
            input.value = '';

            try {
                const response = await fetch('/api/v6/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signal: signal })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let outputContainer = document.createElement('div');
                outputContainer.className = "text-green-400 mt-2 whitespace-pre-wrap";
                log.appendChild(outputContainer);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    outputContainer.innerHTML += chunk;
                    log.scrollTop = log.scrollHeight;
                }
                
                // Update metrics after request
                updateMetrics();
                
            } catch (err) {
                log.innerHTML += `<div class="text-red-500 mt-2">[CRITICAL_ERR]: ${err.message}</div>`;
            }
        }

        // Initialize metrics updates
        updateMetrics();
        metricsInterval = setInterval(updateMetrics, 5000); // Update every 5 seconds
    </script>
</body>
</html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       